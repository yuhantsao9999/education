<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>class</title>
    <link rel="stylesheet" href="./css/course.css" />
</head>

<body class="about">
    <div id="header">

        <div class="full-width container clearfix">
            <div>
                <div class="nav_item_bar">
                    <a href="./index.html"> <img id="logo" src="./img/logo.png" alt="logo"></a>
                    <a class="search" href="">探索</a>
                    <!-- <input id="search" style="font-size:20px" onkeyup="search_course_enter()"> -->

                    <div class="search__container">
                        <input class="search__input" type="text" placeholder="Search" onkeyup="search_course_enter()">
                    </div>
                    <button onclick="search_course()" type="submit"></button>
                    <div id="nav" class="col-8">
                        <ul class="clearfix" id="clearfix">
                            <li class="active"><a href="./course_input.html">我要開課</a></li>
                            <li class="boundary"><a href="./profile_student.html">我的課表</a></li>
                            <!-- <li><a href="./sign_in.html">登入</a></li>
                                <li><a href="./profile.html">hi yuhan!</a></li> -->
                            <!-- <li><a href="./sign_up.html"><i class="icon-search"></i> 註冊</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ---------大報 -->
    <div id="content">
        <div class="header">
            <div class="container clearfix">

                <div class="row">
                    <div class="col-12" id="classInfo">
                        <h1 class="title" id="title"></h1>
                        <h3 class="subtitle" id="course_content"></h3>
                        <h3 class="subtitle" id="course_teacher"></h3>
                        <div class="star">
                            <div class="ratings">
                                <div class="empty-stars"></div>
                                <!-- <div class="full-stars" style="width:80%"> -->
                            </div>
                            <h3 class="subtitle" id="comment_numebr"></h3>
                        </div>

                    </div>
                    <!-- <input class="add_class" onclick="add_course()" type="button" value="加入課表" name="按鈕名稱"> -->
                </div>
            </div>
        </div>
    </div>
    <!-- ---------內容 ------->
    <div class="container">
        <h2> <b class="ContentSubtitle" style="margin: 0 -15px;">課程內容</b> </h2>
    </div>

    <div id="class_chapter_section" class="container">

        <div class="class_chapter_section_container" id="class_chapter_section_container">

            <!-- <div class="row clearfix">

                    <div class="col-2">
                        <div class="one" id="test"></div>
                    </div>


                    <div id=chapter_section_detail>
                        <div class="col-10">
                            <h3 class="title"></h3>
                            <p>
                            </p>
                            <p>
                            </p>
                        </div>
                    </div>
                </div> -->
        </div>
        <div class="teacher">
            <div class="teacher_name"></div>
            <div class="teacher_detail">
                <div class="picture">
                    <div class="picture_circle">
                        <img src="./img/profile.png" alt="">
                    </div>
                </div>
                <div class="small_icon">
                    <!-- <a href="#"> <img src=" ./img/home2.png" alt=""></a> -->
                    <!-- <a href="#"> <img src="./img/youtube2.png" alt=""></a>
                        <a href="#"> <img src="./img/facebook2.png" alt=""></a> -->
                </div>

                <div class="teacher_intro">
                    <!-- 大家好，我是彭兆蔚，彭彭老師： -->
                </div>
            </div>
        </div>

    </div>
    <div class="container">
        <h2> <b class="ContentSubtitle" style="margin: 0 -15px;">評論</b> </h2>
    </div>
    <div class="container">
        <!-- <div class="class_container" id="class_container"> -->
        <div class="comment">

            <!-- <div class="each_comment">
                <div class="comment_by">
                    <h3>MN</h3>
                    <p>2018/4/18</p>
                </div>

                <div class="comment_content">
                    <div class="star">
                        <div class="ratings">
                            <div class="empty-stars">
                                <div class="full-stars" style="width:80%">
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>影片聲音太小聽不太到</p>
                </div>

            </div>
            <div class="each_comment">
                <div class="comment_by">
                    <h3>MN</h3>
                    <p>4月 18, 2018</p>
                </div>
                <div class="comment_content">
                    <div>AAAAA 星星</div>
                    <p>影片聲音太小聽不太到</p>
                </div>
            </div> -->

            <!-- <div class="summary gray-bg">
            <div class="container">

                <div class="row">
                    <div class="col-3">
                        <i class="icon-squares108"></i>
                        <div class="count">36</div>
                        <h4>人已選課</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-television53"></i>
                        <div class="count">36%</div>
                        <h4>的人透過此課程找到工作</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-datastorage5"></i>
                        <div class="count">36</div>
                        <h4>則評論</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-statistics27"></i>
                        <div class="count">5.0</div>
                        <h4>顆星</h4>
                    </div>
                </div>

            </div>
        </div> -->
        </div>
    </div>

    <div class="clients">
        <div class="container">
            <div class="intro big">
                <h2 class="title">對這門課感興趣的人也看了</h2>

            </div>

            <div class="row">
                <div class="col-2">
                    <img src="./img/1.png" alt="logo" />
                </div>
                <div class="col-2">
                    <img src="./img/2.png" alt="logo" />
                </div>
                <div class="col-2">
                    <img src="./img/3.png" alt="logo" />
                </div>
                <div class="col-2">
                    <img src="./img/1.png" alt="logo" />
                </div>
                <div class="col-2">
                    <img src="./img/2.png" alt="logo" />
                </div>
                <div class="col-2">
                    <img src="./img/3.png" alt="logo" />
                </div>
            </div>

        </div>
    </div>

    </div>

    <div id="footer" class="dark">

        <div class="info">
            <div class="container">

                <div class="row">
                    <div class="col-3">
                        <img id="logo" src="./img/logo.png" alt="massive" />
                        <p>讓學習<br>無時無刻無距離</p>
                    </div>
                    <div class="col-3">
                        <h4 class="title">recent posts</h4>
                        <ul class="common-list">
                            <li><a href="#">standard blog post</a></li>
                            <li><a href="#">quotation post</a></li>
                            <li><a href="#">audio post</a></li>

                        </ul>
                    </div>
                    <div class="col-3">
                        <h4 class="title">快速連結</h4>
                        <ul class="common-list">
                            <li><a href="#">關於我們</a></li>
                            <li><a href="#">回到主頁</a></li>
                            <li><a href="#">我要開課</a></li>
                        </ul>
                    </div>

                </div>

            </div>
        </div>

        <div class="bottom">
            <div class="container clearfix">

                <div class="copyright">
                    <div class="title">Copyright 2019 by <a href="#">yuhan</a> | All Rights Reserved</div>
                </div>

                <div class="social-media">
                    <ul>
                        <li><a href="#"><i class="icon-facebook"></i></a></li>
                        <li><a href="#"><i class="icon-twitter"></i></a></li>
                        <li><a href="#"><i class="icon-dribbble"></i></a></li>
                        <li><a href="#"><i class="icon-gplus"></i></a></li>
                        <li><a href="#"><i class="icon-behance"></i></a></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <a href="#header" id="go-top"><i class="icon-up-open"></i></a>

</body>
<script>
    //search
    function search_course_enter() {
        if (event.keyCode == 13)
            search_course();
    }

    // get search course data 
    function search_course() {
        var client_keyword = document.getElementById("search").value;

        // function ucfirst(str) {
        var lowcase_keyword = client_keyword.toLowerCase();
        var keyword_arr = lowcase_keyword.split(' ');
        for (var i = 0; i < keyword_arr.length; i++) {
            var result = keyword_arr[i].substring(0, 1).toUpperCase() + keyword_arr[i].substring(1).toLowerCase();
        }
        // console.log(result)
        window.location.replace("./search.html?keyword=" + result);
    }


    //get內容
    accessToken = localStorage.getItem("accessToken")
    const urlParams = new URLSearchParams(window.location.search);
    const title = urlParams.get('title');
    // console.log(title)
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", "/education/classinfo?title=" + title, true);
    xmlhttp.setRequestHeader("Authorization", "Bearer" + " " + accessToken);
    xmlhttp.send(null);
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var obj = JSON.parse(xmlhttp.responseText)
                // console.log("OHHHHHHHHH: " + JSON.stringify(obj))
                //替換課程名稱
            var titleDiv = document.createElement("div");
            var titleContent = document.createTextNode(obj.data.Course_title);
            // console.log(titleContent)
            titleDiv.appendChild(titleContent);
            document.getElementById("title").appendChild(titleDiv)

            //替換課程內容
            var contentDiv = document.createElement("div");
            var contentContent = document.createTextNode(obj.data.Course_intro);
            contentDiv.appendChild(contentContent);
            document.getElementById("course_content").appendChild(contentDiv)

            //替換課程老師
            var teacherDiv = document.createElement("div");
            var teacherContent = document.createTextNode("授課教師 : " + obj.data.Course_teacher);
            teacherDiv.appendChild(teacherContent);
            document.getElementById("course_teacher").appendChild(teacherDiv)

            //替換星數
            // <div class="ratings">
            //                     <div class="empty-stars"></div>
            //                     <div class="full-stars" style="width:80%">
            //                   </div>
            //                 </div>
            //                 <h3 class="subtitle" id="comment_numebr">4.5 (37則評論）</h3>
            var starDiv = document.createElement("div");
            starDiv.className = "full-stars";
            starDiv.style = "width:" + (obj.data.average_star / 5 * 100) + "%"

            document.getElementsByClassName("ratings")[0].appendChild(starDiv)
            var average_star = String(obj.data.average_star)
            console.log(typeof(average_star))
            if (average_star.length < 3) {
                average_star = average_star + ".0"
            } else if (average_star == "null") {
                console.log("ysss ")
                average_star = "0.0"
                obj.data.comment_number = "課程新上架 0"
            }
            var comment_numebrContent = document.createTextNode(average_star + " (" + obj.data.comment_number + "則評論)");
            document.getElementById("comment_numebr").appendChild(comment_numebrContent)

            //按鈕
            var buttomInput = document.createElement("input");
            buttomInput.className = "add_class"
            buttomInput.setAttribute("onClick", "add_course()");
            buttomInput.type = "button"
            buttomInput.id = "add_class"
            buttomInput.value = "加入課程"
                // buttomInput.setAttribute("style", "display:block");
                // buttomInput.style.display = "block"
            buttomInput.name = "按鈕名稱"
            document.getElementById("classInfo").appendChild(buttomInput)


            //替換章節ID
            var number = obj.data.Course_detail.length
                // console.log("Course_detail的長度 ： " + number)
            for (var i = 0; i < obj.data.Course_detail.length; i++) {

                var chapterDiv = document.createElement("div");
                var rowDiv = document.createElement("div");
                var colDiv = document.createElement("div");
                rowDiv.className = "col-2"
                colDiv.className = "one"
                var chapterContent = document.createTextNode(i + 1);
                chapterDiv.className = "row clearfix"

                //TODO:應該要註冊過後才可以看影片
                accessToken = localStorage.getItem("accessToken")
                if (accessToken) {
                    var chapterDiv_a = document.createElement("a");
                    // obj.data.Course_detail[i].Chapter_id
                    //TODO:目前全部都會連到第一章第一個影片
                    chapterDiv_a.href = ("/video.html?title=" + obj.data.Course_title + "&chapter=1&section=1&section_id=1");
                } else {
                    var chapterDiv_a = document.createElement("a");
                }

                colDiv.appendChild(chapterContent);
                rowDiv.appendChild(colDiv);
                chapterDiv_a.appendChild(rowDiv);
                // chapterDiv.appendChild(chapterDiv_a);
                // document.getElementById("class_chapter_section_container").appendChild(chapterDiv)

                //替換章節內容
                var chapter_title_Div = document.createElement("div");
                var chapter_row_Div = document.createElement("h3");
                var chapter_section_detail_div = document.createElement("div");

                chapter_row_Div.className = "col-10"
                chapter_section_detail_div.className = "chapter_section_detail"

                var chapter_title_Content = document.createTextNode(obj.data.Course_detail[i].Chapter_title);
                // console.log(chapter_title_Content)

                chapter_row_Div.appendChild(chapter_title_Content)
                chapter_section_detail_div.appendChild(chapter_row_Div)

                // chapterDiv.appendChild(chapterDiv_a);
                // document.getElementById("class_chapter_section_container").appendChild(chapterDiv)

                // console.log(obj.data.Course_detail[i].Chapter_detail.length)
                var section_div = document.createElement("div");
                for (var k = 0; k < obj.data.Course_detail[i].Chapter_detail.length; k++) {
                    //替換節的內容
                    var section_title_Div = document.createElement("p");
                    var section_title_Content = document.createTextNode(obj.data.Course_detail[i].Chapter_detail[k].Section_title);
                    // console.log(section_title_Content)

                    section_title_Div.appendChild(section_title_Content);

                    section_div.appendChild(section_title_Div)
                    chapter_section_detail_div.appendChild(section_div)
                        // console.log("testttttttt")
                }

                chapterDiv_a.appendChild(chapter_section_detail_div);
                chapterDiv.appendChild(chapterDiv_a);

                chapterDiv_a.appendChild(chapter_section_detail_div);
                document.getElementById("class_chapter_section_container").appendChild(chapterDiv)
            }

        }



    }

    // get search course data
    function search_course() {
        var keyword = document.getElementById("search").value;
        window.location.replace("./search.html?keyword=" + keyword);
    }

    //display none buttom
    var xml = new XMLHttpRequest();
    accessToken = localStorage.getItem("accessToken");

    xml.open("POST", "/user/button");
    const course_title = urlParams.get('title');
    var js = {
        course_title: course_title
    }
    xml.setRequestHeader('Content-Type', 'application/json');
    xml.setRequestHeader("Authorization", "Bearer " + accessToken);
    xml.send(JSON.stringify(js));
    xml.onload = function() {
        var registered = xml.responseText;
        // console.log(xml.responseText)
        if (registered == "registered") {
            // alert("課程已註冊過");
            window.addEventListener("load", function() {
                document.getElementById("add_class").setAttribute("style", "display:none");
            })
        } else { //error
            // alert("課程尚未註冊過");
            // var buttomInput = document.createElement("input");
            // buttomInput.className = "add_class"
            // buttomInput.setAttribute("onClick", "add_course()");
            // buttomInput.type = "button"
            // buttomInput.value = "加入課程"
            // buttomInput.name = "按鈕名稱"
            // document.getElementById("classInfo").appendChild(buttomInput)
            // <input class="add_class" onclick="add_course()" type="button" value="加入課表" name="按鈕名稱">
        }
    }

    //add course in user table
    function add_course() {
        accessToken = localStorage.getItem("accessToken")
        if (!accessToken) {
            alert("請先登入會員");
            var url = ("./sign_in.html")
            window.location.assign(url)
        } else {

            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("POST", "/user/addcourse");
            const urlParams = new URLSearchParams(window.location.search);
            const course_title = urlParams.get('title');
            var js = {
                course_title: course_title
            }
            xmlhttp.setRequestHeader('Content-Type', 'application/json');
            xmlhttp.setRequestHeader("Authorization", "Bearer " + accessToken);
            xmlhttp.send(JSON.stringify(js));
            xmlhttp.onload = function() {
                // console.log(xmlhttp.responseText)
                var email = xmlhttp.responseText;
                if (!email) {
                    alert("請先登入會員");
                    var url = ("./sign_in.html")
                    window.location.assign(url)
                } else {
                    alert("課程加入成功")
                    var url = ("./profile_student.html")
                    window.location.assign(url)
                }
            }
        }
    }


    //加入老師資訊
    // console.log("課程標題 : " + course_title)
    var xml_teacher = new XMLHttpRequest();
    xml_teacher.open("post", "/course/teacher/info", true);
    //display none buttom已經宣告過了
    var course_title_obj = {
        course_title: course_title
    }
    xml_teacher.setRequestHeader('Content-Type', 'application/json');
    // xml_teacher.setRequestHeader("Authorization", "Bearer " + accessToken);
    // console.log("accessToken : " + accessToken)
    xml_teacher.send(JSON.stringify(course_title_obj));
    xml_teacher.onreadystatechange = function() {
        if (xml_teacher.readyState == 4) {
            var obj = JSON.parse(xml_teacher.responseText)
                // console.log("obj : " + JSON.stringify(obj))
                //更換老師資訊
            var teacher_name = obj[0].course_teacher
                // console.log("teacher : " + teacher_name)
                // <div class="teacher_name"><b>關於老師 XXXX</b></div>
            var teacher_nameB = document.createElement("b");
            var teacher_nameContent = document.createTextNode("關於老師 " + teacher_name);
            teacher_nameB.appendChild(teacher_nameContent);
            document.getElementsByClassName("teacher_name")[0].appendChild(teacher_nameB);


            //更換圖片
            //TODO:要讓使用者可以先更換圖片
            // <img src="./img/golang.png" alt="">
            // var teacher_image = obj[0].user_image;
            // var teacher_imageImg = document.createElement("img");
            // teacher_imageImg.src=""


            //更換icon
            // <a href="#"> <img src="./img/home2.png" alt=""></a>
            // <a href="#"> <img src="./img/youtube2.png" alt=""></a>
            // <a href="#"> <img src="./img/facebook2.png" alt=""></a>
            var icon_homeA = document.createElement("a");
            var icon_homeHref = obj[0].PersonalWebsite;
            // console.log(typeof(icon_homeHref))
            if (icon_homeHref !== null && icon_homeHref !== undefined && icon_homeHref !== '') {
                icon_homeA.href = icon_homeHref;
                var icon_homeImg = document.createElement("img");
                icon_homeImg.src = "./img/home2.png"
                icon_homeA.appendChild(icon_homeImg);
                document.getElementsByClassName("small_icon")[0].appendChild(icon_homeA);
            }


            var icon_facebookA = document.createElement("a");
            var icon_facebookHref = obj[0].facebookProfile
            if (icon_facebookHref !== null && icon_facebookHref !== undefined && icon_facebookHref !== '') {
                icon_facebookA.href = ("http://www.facebook.com/" + icon_facebookHref);
                var icon_facebookImg = document.createElement("img");
                icon_facebookImg.src = "./img/facebook2.png";
                icon_facebookA.appendChild(icon_facebookImg);
            }
            document.getElementsByClassName("small_icon")[0].appendChild(icon_facebookA);

            var icon_youtuebeA = document.createElement("a");
            var icon_youtuebeHref = obj[0].youtubeProfile;
            // console.log(icon_youtuebeHref)
            // console.log(typeof(icon_youtuebeHref))
            if (icon_youtuebeHref !== null && icon_youtuebeHref !== undefined && icon_youtuebeHref !== '') {
                icon_youtuebeA.href = ("http://www.youtube.com/" + icon_youtuebeHref);
                var icon_youtuebeImg = document.createElement("img");
                icon_youtuebeImg.src = "./img/youtube2.png"
                icon_youtuebeA.appendChild(icon_youtuebeImg)
                document.getElementsByClassName("small_icon")[0].appendChild(icon_youtuebeA);
            }

            //更換介紹文字
            var about_meContent = document.createTextNode(obj[0].about_me);
            document.getElementsByClassName("teacher_intro")[0].appendChild(about_meContent);
        }
    }


    //comment 
    var xml_comment = new XMLHttpRequest();
    xml_comment.open("post", "/course/comment", true);
    var course_title_obj = {
        course_title: course_title,
    }
    xml_comment.setRequestHeader('Content-Type', 'application/json');;
    xml_comment.send(JSON.stringify(course_title_obj));
    xml_comment.onreadystatechange = function() {
        if (xml_comment.readyState == 4) {
            var obj = JSON.parse(xml_comment.responseText)
            console.log(JSON.stringify(obj))
            console.log(obj.length)
            if (obj.length == 0) {
                var no_comment_div = document.createElement("div");
                no_comment_div.className = "no_comment"
                var no_comment = document.createTextNode("此課程尚無任何評論。");
                no_comment_div.appendChild(no_comment);
                document.getElementsByClassName("comment")[0].appendChild(no_comment_div)
            } else {

                // console.log(obj[0])
                for (i = 0; i < obj.length; i++) {
                    var each_comment_div = document.createElement("div");
                    each_comment_div.className = "each_comment"

                    var name_h3 = document.createElement("h3");
                    var date_p = document.createElement("p");
                    var comment_by_div = document.createElement("div");
                    comment_by_div.className = "comment_by"
                    var name = document.createTextNode(obj[i].name)
                    var comment_date = document.createTextNode(obj[i].comment_date)

                    name_h3.appendChild(name);
                    date_p.appendChild(comment_date);
                    comment_by_div.appendChild(name_h3)
                    comment_by_div.appendChild(date_p)

                    var full_stars_div = document.createElement("div");
                    full_stars_div.className = "full-stars";
                    full_stars_div.style = "width:" + obj[i].star / 5 * 100 + "%";

                    var empty_stars_div = document.createElement("div");
                    empty_stars_div.className = "each_comment"
                    var ratings_div = document.createElement("div");
                    ratings_div.className = "ratings"
                    var star_div = document.createElement("div");
                    star_div.className = "star"
                    var empty_stars_div = document.createElement("div");
                    empty_stars_div.className = "empty-stars"

                    empty_stars_div.appendChild(full_stars_div)

                    var comment_p = document.createElement("p");

                    var comment_content_div = document.createElement("div");
                    comment_content_div.className = "comment_content"
                    var comment_content = document.createTextNode(obj[i].comment);
                    comment_p.appendChild(comment_content)

                    ratings_div.appendChild(empty_stars_div)
                    star_div.appendChild(ratings_div)
                    comment_content_div.appendChild(star_div)
                    comment_content_div.appendChild(comment_p)

                    each_comment_div.appendChild(comment_by_div)
                    each_comment_div.appendChild(comment_content_div)
                    document.getElementsByClassName("comment")[0].appendChild(each_comment_div)
                        // <div class="each_comment">

                    //     <div class="comment_by">
                    //         <h3>MN</h3>
                    //         <p>2018/4/18</p>
                    //     </div>

                    //     <div class="comment_content">
                    //         <div class="star">
                    //             <div class="ratings">
                    //                 <div class="empty-stars">
                    //                     <div class="full-stars" style="width:80%">
                    //                     </div>
                    //                 </div>
                    //             </div>
                    //         </div>
                    //         <p>影片聲音太小聽不太到</p>
                    //     </div>
                }
            }
        }
    }


    // user_sign_icon
    accessToken = localStorage.getItem("accessToken")
    console.log("accessToken" + accessToken)
    var xml_icon = new XMLHttpRequest();
    xml_icon.open("get", "/profile/getinfo", true);
    xml_icon.setRequestHeader("Authorization", "Bearer" + " " + accessToken);
    xml_icon.send(null);
    xml_icon.onreadystatechange = function() {
        if (xml_icon.readyState == 4) {
            if (xml_icon.responseText == "error") {
                //還沒登入
                var sign_li = document.createElement("li");
                var signContent = document.createTextNode("登入");
                var sign_a = document.createElement("a");
                sign_a.href = "./sign_in.html"
                sign_a.appendChild(signContent)
                sign_li.appendChild(sign_a)
                document.getElementById("clearfix").appendChild(sign_li)
            } else {
                //已登入
                var sign_li = document.createElement("li");
                var signContent = document.createTextNode("Hello!");
                var sign_a = document.createElement("a");
                sign_a.href = "./profile.html?tab=current"
                sign_a.appendChild(signContent)
                sign_li.appendChild(sign_a)
                document.getElementById("clearfix").appendChild(sign_li)
            }
        }
    }


    //search
    function search_course_enter() {
        if (event.keyCode == 13)
            search_course();
    }

    // get search course data 
    function search_course() {
        var client_keyword = document.getElementsByClassName("search__input")[0].value;

        // function ucfirst(str) {
        var lowcase_keyword = client_keyword.toLowerCase();
        var keyword_arr = lowcase_keyword.split(' ');
        for (var i = 0; i < keyword_arr.length; i++) {
            var result = keyword_arr[i].substring(0, 1).toUpperCase() + keyword_arr[i].substring(1).toLowerCase();
        }
        // console.log(result)
        window.location.replace("./search.html?keyword=" + result);
    }
</script>


</html>