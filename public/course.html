<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>class</title>
    <link rel="stylesheet" href="./css/course.css" />
</head>

<body class="about">
    <div id="header">

        <div class="full-width container clearfix">
            <div>
                <div class="nav_item_bar">
                    <a href="./index.html"> <img id="logo" src="./img/logo.png" alt="logo"></a>
                    <a class="search" href="">探索</a>
                    <input id="search" style="font-size:20px">
                    <button onclick="search_course()" type="submit"></button>

                    <div id="nav" class="col-8">
                        <ul class="clearfix" id="clearfix">
                            <li class="active"><a href="#">我要開課</a></li>
                            <li class="boundary"><a href="./profile.html">我的課表</a></li>
                            <!-- <li class="boundary"><a href="./sign_in.html">登入</a></li> -->
                            <!-- <li><a href="./sign_up.html"><i class="icon-search"></i> 註冊</a></li> -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ---------大報 -->
    <div id="content">
        <div class="header">
            <div class="container clearfix">

                <div class="row">
                    <div class="col-12" id="classInfo">
                        <h1 class="title" id="title"></h1>
                        <h3 class="subtitle" id="course_content"></h3>
                        <h3 class="subtitle" id="course_teacher"></h3>
                        <!-- <input class="add_class" onclick="add_course()" type="button" value="加入課表" name="按鈕名稱"> -->
                    </div>
                </div>
            </div>
        </div>
        <!-- ---------內容 ------->
        <div id="class_chapter_section">
            <div class="class_chapter_section_container" id="class_chapter_section_container">
                <!-- <div class="row clearfix">

                    <div class="col-2">
                        <div class="one" id="test"></div>
                    </div>


                    <div id=chapter_section_detail>
                        <div class="col-10">
                            <h3 class="title"></h3>
                            <p>
                            </p>
                            <p>
                            </p>
                        </div>
                    </div>
                </div> -->
            </div>

        </div>

        <div class="summary gray-bg">
            <div class="container">

                <div class="row">
                    <div class="col-3">
                        <i class="icon-squares108"></i>
                        <div class="count">36</div>
                        <h4>人已選課</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-television53"></i>
                        <div class="count">36%</div>
                        <h4>的人透過此課程找到工作</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-datastorage5"></i>
                        <div class="count">36</div>
                        <h4>則評論</h4>
                    </div>
                    <div class="col-3">
                        <i class="icon-statistics27"></i>
                        <div class="count">5.0</div>
                        <h4>顆星</h4>
                    </div>
                </div>

            </div>
        </div>

        <div class="clients">
            <div class="container">

                <div class="intro big">
                    <h2 class="title">對這門課感興趣的人也看了</h2>
                    <p></p>
                </div>

                <div class="row">
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                    <div class="col-2">
                        <img src="#" alt="logo" />
                    </div>
                </div>

            </div>
        </div>

    </div>

    <div id="footer" class="dark">

        <div class="info">
            <div class="container">

                <div class="row">
                    <div class="col-3">
                        <img id="logo" src="./img/logo.png" alt="massive" />
                        <p>讓學習<br>無時無刻無距離</p>
                    </div>
                    <div class="col-3">
                        <h4 class="title">recent posts</h4>
                        <ul class="common-list">
                            <li><a href="#">standard blog post</a></li>
                            <li><a href="#">quotation post</a></li>
                            <li><a href="#">audio post</a></li>

                        </ul>
                    </div>
                    <div class="col-3">
                        <h4 class="title">快速連結</h4>
                        <ul class="common-list">
                            <li><a href="#">關於我們</a></li>
                            <li><a href="#">回到主頁</a></li>
                            <li><a href="#">我要開課</a></li>
                        </ul>
                    </div>

                </div>

            </div>
        </div>

        <div class="bottom">
            <div class="container clearfix">

                <div class="copyright">
                    <div class="title">Copyright 2019 by <a href="#">yuhan</a> | All Rights Reserved</div>
                </div>

                <div class="social-media">
                    <ul>
                        <li><a href="#"><i class="icon-facebook"></i></a></li>
                        <li><a href="#"><i class="icon-twitter"></i></a></li>
                        <li><a href="#"><i class="icon-dribbble"></i></a></li>
                        <li><a href="#"><i class="icon-gplus"></i></a></li>
                        <li><a href="#"><i class="icon-behance"></i></a></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <a href="#header" id="go-top"><i class="icon-up-open"></i></a>

</body>
<script>
    accessToken = localStorage.getItem("accessToken")
    const urlParams = new URLSearchParams(window.location.search);
    const title = urlParams.get('title');
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", "/education/classinfo?title=" + title, true);
    xmlhttp.setRequestHeader("Authorization", "Bearer" + " " + accessToken);
    xmlhttp.send(null);
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var obj = JSON.parse(xmlhttp.responseText)

            //替換課程名稱
            var titleDiv = document.createElement("div");
            var titleContent = document.createTextNode(obj.data.Course_title);
            titleDiv.appendChild(titleContent);
            document.getElementById("title").appendChild(titleDiv)

            //替換課程內容
            var contentDiv = document.createElement("div");
            var contentContent = document.createTextNode(obj.data.Course_intro);
            contentDiv.appendChild(contentContent);
            document.getElementById("course_content").appendChild(contentDiv)

            //替換課程老師
            var teacherDiv = document.createElement("div");
            var teacherContent = document.createTextNode("授課教師 : " + obj.data.Course_teacher);
            teacherDiv.appendChild(teacherContent);
            document.getElementById("course_teacher").appendChild(teacherDiv)

            //替換章節ID
            var number = obj.data.Course_detail.length
                // console.log(number)
            for (var i = 0; i < obj.data.Course_detail.length; i++) {

                var chapterDiv = document.createElement("div");
                var rowDiv = document.createElement("div");
                var colDiv = document.createElement("div");
                rowDiv.className = "col-2"
                colDiv.className = "one"
                var chapterContent = document.createTextNode(obj.data.Course_detail[i].Chapter_id);
                chapterDiv.className = "row clearfix"


                accessToken = localStorage.getItem("accessToken")
                if (accessToken) {
                    var chapterDiv_a = document.createElement("a");
                    chapterDiv_a.href = ("/video.html?title=" + obj.data.Course_title + "&chapter=" + obj.data.Course_detail[i].Chapter_id + "&section=1");
                } else {
                    var chapterDiv_a = document.createElement("a");
                }

                colDiv.appendChild(chapterContent);
                rowDiv.appendChild(colDiv);
                chapterDiv_a.appendChild(rowDiv);
                // chapterDiv.appendChild(chapterDiv_a);
                // document.getElementById("class_chapter_section_container").appendChild(chapterDiv)

                //替換章節內容
                var chapter_title_Div = document.createElement("div");
                var chapter_row_Div = document.createElement("h3");
                var chapter_section_detail_div = document.createElement("div");

                chapter_row_Div.className = "col-10"
                chapter_section_detail_div.className = "chapter_section_detail"

                var chapter_title_Content = document.createTextNode(obj.data.Course_detail[i].Chapter_title);
                // console.log(chapter_title_Content)

                chapter_row_Div.appendChild(chapter_title_Content)
                chapter_section_detail_div.appendChild(chapter_row_Div)
                chapterDiv_a.appendChild(chapter_section_detail_div);
                // chapterDiv.appendChild(chapterDiv_a);
                // document.getElementById("class_chapter_section_container").appendChild(chapterDiv)

                // console.log(obj.data.Course_detail[i].Chapter_detail.length)
                for (var k = 0; k < obj.data.Course_detail[i].Chapter_detail.length; k++) {
                    //替換節的內容
                    var section_title_Div = document.createElement("p");
                    var section_title_Content = document.createTextNode(obj.data.Course_detail[i].Chapter_detail[k].Section_title);
                    // console.log(section_title_Content)
                    section_title_Div.appendChild(section_title_Content);
                    chapterDiv_a.appendChild(section_title_Div);
                    chapterDiv.appendChild(chapterDiv_a);
                    document.getElementById("class_chapter_section_container").appendChild(chapterDiv)

                }

            }

        }



    }

    // get search course data
    function search_course() {
        var keyword = document.getElementById("search").value;
        window.location.replace("./search.html?keyword=" + keyword);
    }

    //display none buttom
    var xml = new XMLHttpRequest();
    accessToken = localStorage.getItem("accessToken")
    xml.open("POST", "/user/button");
    const course_title = urlParams.get('title');
    var js = {
        course_title: course_title
    }
    xml.setRequestHeader('Content-Type', 'application/json');
    xml.setRequestHeader("Authorization", "Bearer " + accessToken);
    xml.send(JSON.stringify(js));
    xml.onload = function() {
        var registered = xml.responseText;
        console.log(xml.responseText)
        if (registered == "registered") {
            // alert("課程已註冊過")
        } else { //error
            // alert("課程尚未註冊過");
            var buttomInput = document.createElement("input");
            buttomInput.className = "add_class"
            buttomInput.setAttribute("onClick", "add_course()");
            // buttomInput.onclick("onClick", "add_course()");
            // buttomInput.onclick = function() {
            //     add_course()
            // };
            // buttoninput.onclick = "add_course()"
            buttomInput.type = "button"
            buttomInput.value = "加入課程"
            buttomInput.name = "按鈕名稱"
            document.getElementById("classInfo").appendChild(buttomInput)
                // <input class="add_class" onclick="add_course()" type="button" value="加入課表" name="按鈕名稱">

        }
    }

    //add course in user table
    function add_course() {
        var xmlhttp = new XMLHttpRequest();
        accessToken = localStorage.getItem("accessToken")
        xmlhttp.open("POST", "/user/addcourse");
        const urlParams = new URLSearchParams(window.location.search);
        const course_title = urlParams.get('title');
        var js = {
            course_title: course_title
        }
        console.log("test")
        xmlhttp.setRequestHeader('Content-Type', 'application/json');
        xmlhttp.setRequestHeader("Authorization", "Bearer " + accessToken);
        xmlhttp.send(JSON.stringify(js));
        xmlhttp.onload = function() {
            console.log(xmlhttp.responseText)
            var email = xmlhttp.responseText;
            if (!email) {
                alert("請先登入會員");
                var url = ("./sign_in.html")
                window.location.assign(url)
            } else {
                alert("課程加入成功")
                var url = ("./profile.html?email=" + email)
                window.location.assign(url)
            }
        }
    }
    // user_icon
    accessToken = localStorage.getItem("accessToken")
    console.log("accessToken" + accessToken)
    var xml_icon = new XMLHttpRequest();
    xml_icon.open("get", "/user/profile", true);
    xml_icon.setRequestHeader("Authorization", "Bearer" + " " + accessToken);
    xml_icon.send(null);
    xml_icon.onreadystatechange = function() {
        if (xml_icon.readyState == 4) {
            if (xml_icon.responseText == "error") {
                //還沒登入
                var sign_li = document.createElement("li");
                var signContent = document.createTextNode("登入");
                var sign_a = document.createElement("a");
                sign_a.href = "./sign_in.html"
                sign_a.appendChild(signContent)
                sign_li.appendChild(sign_a)
                document.getElementById("clearfix").appendChild(sign_li)
            } else {
                //已登入
                var sign_li = document.createElement("li");
                var signContent = document.createTextNode("Hello!");
                var sign_a = document.createElement("a");
                sign_a.href = "./profile.html?tab=current"
                sign_a.appendChild(signContent)
                sign_li.appendChild(sign_a)
                document.getElementById("clearfix").appendChild(sign_li)
            }
        }
    }
</script>


</html>